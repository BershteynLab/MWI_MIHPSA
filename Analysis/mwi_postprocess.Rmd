---
title: "MWI_emod_postprocess"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/gpfs/data/bershteynlab/EMOD/citrod01/MWI_calib_20220422/Analysis')
```

# Postprocessing MWI model outputs

The collaborators working with us on Malawi want us to produce a standardized set of results. The purpose of this notebook will be to write out scripts which will produce the summary statistics that we need.

The secondary purpose of this notebook will be to produce example scripts which will be compatible with David Kaftan's EMODAnalyzeR library, and add capabilities to his analyzers.

```{r Load libraries}
library(tidyverse)
library(data.table)
library(magrittr)
library(devtools)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

# Read in simulation stuff
```{r}

#input_path = "/gpfs/scratch/citrod01/experiments/Malawi/Baseline-campaign_Malawi_1Dec2021_recalib-Baseline___2022_04_13_14_14_43_389706"
#experiment_path = "/gpfs/scratch/citrod01/experiments/Malawi--0.01--rep3--test2_iter20___2022_04_09_05_03_57_150118",
#experiment_path = "/gpfs/scratch/citrod01/experiments/Baseline-campaign_Malawi_1Dec2021_recalib-Baseline___2022_04_12_18_14_09_084274",
input_path = "/gpfs/scratch/citrod01/experiments/Malawi/Baseline-campaign_Malawi_20220422_recalib-MWI_Base___2024_09_01_16_12_22_555024"

sim.results <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = input_path,
  scenario_name = 'minimal',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive", "Newly.Tested.Negative",
                        "Population","Infected", "On_ART","Died", "Died_from_HIV",
                        "Tested.Past.Year.or.On_ART", "Tested.Ever","Diagnosed",
                        "Infected.CD4.Under.200..Not.On.ART.", "Infected.CD4.200.To.349..Not.On.ART.",
                        "Infected.CD4.350.To.499..Not.On.ART.", "Infected.CD4.500.Plus..Not.On.ART.",
                        "ARTStaging9","HCTTestingLoop0",
                         "Program_VMMC","Traditional_MC"
                        ), # need to add "GaveBirth"
                          # "HCTTestingLoop1","Needs_PMTCT_Diagnostic_Test","HIV_Positive_at_ANC",
                          # "HIV_Negative_at_ANC_NULL","ARTStaging0","ARTStaging1","ARTStaging_Negative_NULL",
  stratify_columns = c("Year", "Gender", "Age"), # Need to add "On_Art_Dim", "HasHIV"; unsure if I need "IP_Key.Risk",  "IsCircumcised"
  min_age_inclusive = 0,
  max_age_inclusive = 99,
  verbose = TRUE
) %>% 
  ungroup()

```


# Population rescaling

Need to scale up everything, for rescaling extensible variables
```{r Population rescaling factor}
CENSUS_YEAR = 2018.5
MALAWI_CENSUS_POP = 17563749

sim.results.pop.scaling <- sim.results %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = MALAWI_CENSUS_POP/total.pop)

sim.results <- sim.results %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

# Flows

## Births

```{r}
# p0 <- sim.results %>% 
#   dplyr::select(Year, Gender, Age, GaveBirth, sim.ix, pop.scaling.factor) %>%
#   filter(Gender == 1, Age > 15, ceiling(Year) != Year) %>% 
#   group_by(Year, sim.ix) %>% 
#   # remember to rescale by population scaling factor!
#   summarize(GaveBirth = sum(GaveBirth*pop.scaling.factor), .groups = 'keep') %>% 
#   group_by(Year) %>% 
#   summarize(N_BirthAll = mean(GaveBirth), .groups = 'keep')
# 
# p1 <- sim.results %>% 
#   dplyr::select(Year, Gender, Age, GaveBirth, sim.ix, pop.scaling.factor) %>%
#   filter(Gender == 1, Age > 15, ceiling(Year) != Year, HasHIV == 1) %>% 
#   group_by(Year, sim.ix) %>% 
#   # remember to rescale by population scaling factor!
#   summarize(GaveBirth = sum(GaveBirth*pop.scaling.factor), .groups = 'keep') %>% 
#   group_by(Year) %>% 
#   summarize(N_BirthAll = mean(GaveBirth), .groups = 'keep')
# 
# p2 <- sim.results %>% 
#   dplyr::select(Year, Gender, Age, GaveBirth, sim.ix, pop.scaling.factor) %>%
#   filter(Gender == 1, Age > 15, ceiling(Year) != Year, HasHIV == 1, On_Art_Dim == 1) %>% 
#   group_by(Year, sim.ix) %>% 
#   # remember to rescale by population scaling factor!
#   summarize(GaveBirth = sum(GaveBirth*pop.scaling.factor), .groups = 'keep') %>% 
#   group_by(Year) %>% 
#   summarize(N_BirthAll = mean(GaveBirth), .groups = 'keep')
```

## New HIV Infections

```{r}
# Children 
p1 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_00_14_C = mean(Newly.Infected), .groups = 'keep')

# Males 15-24
p2 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, Age < 25) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_15_24_M = mean(Newly.Infected), .groups = 'keep')

# Females 15-24
p3 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, Age < 25) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_15_24_F = mean(Newly.Infected), .groups = 'keep')

# Males 25-49
p4 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 25, Age < 50) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_25_49_M = mean(Newly.Infected), .groups = 'keep')

# Females 25-49
p5 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 25, Age < 50) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_25_49_F = mean(Newly.Infected), .groups = 'keep')

# Males 50+
p6 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 50) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_50_UP_M = mean(Newly.Infected), .groups = 'keep')

# Females 50+ 
p7 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Newly.Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 50) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewHIV_50_UP_F = mean(Newly.Infected), .groups = 'keep')

inc.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  merge(p6, by = 'Year') %>%
  merge(p7, by = 'Year') %>%
  mutate(Year = floor(Year))

inc.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Deaths

```{r}
## Died from HIV

# Children 
p1 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsHIV_00_14_C = mean(Died_from_HIV), .groups = 'keep')

# Males 15+
p2 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsHIV_15_UP_M = mean(Died_from_HIV), .groups = 'keep')

# Females 15+
p3 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsHIV_15_UP_F = mean(Died_from_HIV), .groups = 'keep')

## All deaths

# Children 
p4 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsAll_00_14_C = mean(Died), .groups = 'keep')

# Males 15+
p5 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsAll_15_UP_M = mean(Died), .groups = 'keep')

# Females 15+
p6 <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Died, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_DeathsAll_15_UP_F = mean(Died), .groups = 'keep')


deaths.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  merge(p6, by = 'Year') %>%
  mutate(Year = floor(Year))

deaths.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)

```

## YLLs

Note that this is YLL attributable to HIV, not all YLLs

```{r}
dle.table <- read_csv("/gpfs/data/bershteynlab/EMOD/citrod01/MWI_calib_20220422/Analysis/MIHPSA_MWI_YLL_DLE_table.csv")

dle.table <- dle.table %>% 
  pivot_longer(cols = c("Male", "Female"), values_to = "dle") %>%
  mutate(Gender = case_when(name == "Male" ~ 0,
                            name == "Female" ~ 1)) %>%
  select(Age, Gender, dle)
```

```{r}
deaths.ylls <- sim.results %>%
  mutate(Year = ceiling(Year)) %>% 
  group_by(Year, Gender, Age, Died_from_HIV, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor)) %>% 
  group_by(Year, Gender, Age) %>% 
  summarize(Died_from_HIV = mean(Died_from_HIV))

ylls.under.15 <- deaths.ylls %>%
  filter(Age < 15) %>% 
  inner_join(dle.table,
             by = c("Age", "Gender")) %>% 
  mutate(YLL = Died_from_HIV*dle) %>%
  group_by(Year) %>% 
  summarize(N_YLL_00_14_C = sum(YLL))

ylls.15.to.80 <- deaths.ylls %>%
  filter(Age >= 15, Age < 80) %>% 
  inner_join(dle.table,
             by = c("Age", "Gender")) %>% 
  mutate(YLL = Died_from_HIV*dle) %>%
  group_by(Year, Gender) %>% 
  summarize(YLL = sum(YLL))

ylls.over.80 <- deaths.ylls %>%
  filter(Age >= 80) %>% 
  inner_join(dle.table %>% filter(Age >= 80),
             by = c("Gender")) %>% 
  mutate(YLL = Died_from_HIV*dle) %>%
  group_by(Year, Gender) %>% 
  summarize(YLL.80 = sum(YLL))

# Add together ylls over 15 by gender

ylls.summary <- merge(ylls.15.to.80, ylls.over.80,
      by = c("Year", "Gender")) %>% 
  mutate(YLL.tot = YLL + YLL.80) %>% 
  mutate(Gender = case_when(Gender == 0 ~ "N_YLL_15_UP_M",
                            Gender == 1 ~ "N_YLL_15_UP_F")) %>% 
  select(Year, Gender, YLL.tot) %>% 
  pivot_wider(id_cols = c(Year),
              values_from = c(YLL.tot),
              names_from = c(Gender) ) %>% 
  merge(ylls.under.15) %>% 
  select(Year, N_YLL_00_14_C, N_YLL_15_UP_M, N_YLL_15_UP_F)

ylls.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Testing

```{r}
testing.summary <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, ARTStaging9, HCTTestingLoop0, sim.ix, pop.scaling.factor) %>%
  filter(Age >= 15) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(N_HIVTest_Facility_NEG_15_UP = sum(HCTTestingLoop0*pop.scaling.factor), 
            N_HIVTest_Facility_POS_15_UP = sum(ARTStaging9*pop.scaling.factor),
            .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_HIVTest_Facility_NEG_15_UP = mean(N_HIVTest_Facility_NEG_15_UP), 
            N_HIVTest_Facility_POS_15_UP = mean(N_HIVTest_Facility_POS_15_UP), 
            .groups = 'keep') %>%
  mutate(Year = floor(Year))

testing.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Prevention

### VMMC

```{r}
vmmc.summary <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  dplyr::select(Year, Gender, Age, Program_VMMC, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Program_VMMC = sum(Program_VMMC*pop.scaling.factor),
            .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_NewVMMC = mean(Program_VMMC), 
            .groups = 'keep') %>%
  mutate(Year = floor(Year))

vmmc.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```


### Oral Prep

### Art Adherence Support

### VL Testing

### Outreach

### Econ Empowerment

### Sex Ed

# Stocks

## Population

```{r}
# Children - N_Total_00_14_C
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>% 
  group_by(Year, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_00_14_C = mean(Population), .groups = 'keep')

# Males 15-24
p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, Age <25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_15_24_M = mean(Population), .groups = 'keep')

# Females 15-24
p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, Age <25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_15_24_F = mean(Population), .groups = 'keep')

# Males 25-49
p4 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 25, Age <50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_25_49_M = mean(Population), .groups = 'keep')

# Females 15-24
p5 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 25, Age <50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_25_49_F = mean(Population), .groups = 'keep')

# Males 50+
p6 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_50_UP_M = mean(Population), .groups = 'keep')

# Females 15-24
p7 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Total_50_UP_F = mean(Population), .groups = 'keep')

pop.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  merge(p6, by = 'Year') %>%
  merge(p7, by = 'Year') %>%
  mutate(Year = floor(Year))

pop.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```



## PLHIV

```{r People living with HIV}
# Children
p0 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_00_14_C = mean(Infected), .groups = 'keep')

# Males 15-24
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, Age < 25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_15_24_M = mean(Infected), .groups = 'keep')

# Females 15-24
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, Age < 25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_15_24_F = mean(Infected), .groups = 'keep')

# Males 25-49
p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 25, Age < 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_25_49_M = mean(Infected), .groups = 'keep')

# Females 25-49
p4 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 25, Age < 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_25_49_F = mean(Infected), .groups = 'keep')

# Males 50+
p5 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_50_UP_M = mean(Infected), .groups = 'keep')

# Females 50+
p6 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_50_UP_F = mean(Infected), .groups = 'keep')


plhiv.summary <- merge(p0, p1, by = 'Year') %>% 
  merge(p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  merge(p6, by = 'Year') %>%
  mutate(Year = floor(Year))

plhiv.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Diagnosed
```{r}
# Children
p0 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Diag_00_14_C = mean(Diagnosed), .groups = 'keep')

# Males 15-24
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Diag_15_UP_M = mean(Diagnosed), .groups = 'keep')

# Females 15-24
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_Diag_15_UP_F = mean(Diagnosed), .groups = 'keep')

diag.summary <- merge(p0, p1, by = 'Year') %>% 
  merge(p2, by = 'Year') %>%
  mutate(Year = floor(Year))

diag.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```



## OnART
```{r}
p0 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, sim.ix, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_ART_00_14_C = mean(On_ART), .groups = 'keep')

# Males 15-24
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_ART_15_UP_M = mean(On_ART), .groups = 'keep')

# Females 15-24
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, sim.ix, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.ix) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_ART_15_UP_F = mean(On_ART), .groups = 'keep')

onart.summary <- merge(p0, p1, by = 'Year') %>% 
  merge(p2, by = 'Year') %>% 
  mutate(N_VLS_15_UP_M = 0.92 * N_ART_15_UP_M,
         N_VLS_15_UP_F = 0.92 * N_ART_15_UP_F)%>%
  mutate(Year = floor(Year))

onart.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```
## CD4 counts
Assume 1/8 of people under CD4 = 200 are < 50 - we made this same assumption with MIHPSA ZWE
```{r}
cd4.summary <- sim.results %>% 
  dplyr::select(Year, Age, 
                Infected.CD4.500.Plus..Not.On.ART., 
                Infected.CD4.350.To.499..Not.On.ART.,
                Infected.CD4.200.To.349..Not.On.ART.,
                Infected.CD4.Under.200..Not.On.ART.,
                sim.ix, pop.scaling.factor) %>%
  filter(Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, sim.ix) %>% 
  summarize(Infected.CD4.500.Plus..Not.On.ART. = sum(Infected.CD4.500.Plus..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.350.To.499..Not.On.ART. = sum(Infected.CD4.350.To.499..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.200.To.349..Not.On.ART. = sum(Infected.CD4.200.To.349..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.Under.200..Not.On.ART. = sum(Infected.CD4.Under.200..Not.On.ART.*pop.scaling.factor), 
            .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(N_PLHIV_15_UP_CD4_500_INF = mean(Infected.CD4.500.Plus..Not.On.ART.), 
            N_PLHIV_15_UP_CD4_350_500 = mean(Infected.CD4.350.To.499..Not.On.ART.),
            N_PLHIV_15_UP_CD4_200_350 = mean(Infected.CD4.200.To.349..Not.On.ART.),
            N_PLHIV_15_UP_CD4_050_200 = 7/8*mean(Infected.CD4.Under.200..Not.On.ART.),
            N_PLHIV_15_UP_CD4_000_050 = 1/8*mean(Infected.CD4.Under.200..Not.On.ART.),
            .groups = 'keep') %>% 
  ungroup() %>%
  mutate(Year = floor(Year))

cd4.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Brief Check - total number diagnosed

```{r}
plhiv.summary %>% 
  merge(onart.summary, by = c("Year")) %>%
  mutate(N_PLHIV_M = N_PLHIV_15_24_M + N_PLHIV_25_49_M + N_PLHIV_50_UP_M,
         N_PLHIV_F = N_PLHIV_15_24_F + N_PLHIV_25_49_F + N_PLHIV_50_UP_F) %>% 
  mutate(NoART_M = N_PLHIV_M - N_ART_15_UP_M,
         NoART_F = N_PLHIV_F - N_ART_15_UP_F) %>% 
  mutate(NoART = NoART_F + NoART_M)
```
```{r}
cd4.summary %>% mutate(Tot = 
                         N_PLHIV_15_UP_CD4_500_INF + N_PLHIV_15_UP_CD4_350_500 + 
                         N_PLHIV_15_UP_CD4_200_350 + N_PLHIV_15_UP_CD4_050_200 +
                         N_PLHIV_15_UP_CD4_000_050)
```
```{r}
noart.summary <- sim.results %>% 
  filter(Year != ceiling(Year), Age > 15) %>% 
  dplyr::select(Year,
                Infected,
                On_ART,
                Infected.CD4.500.Plus..Not.On.ART., 
                Infected.CD4.350.To.499..Not.On.ART.,
                Infected.CD4.200.To.349..Not.On.ART.,
                Infected.CD4.Under.200..Not.On.ART.,
                sim.ix, pop.scaling.factor) %>% 
  group_by(Year, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop.scaling.factor),
            On_ART = sum(On_ART* pop.scaling.factor),
            Infected.CD4.500.Plus..Not.On.ART. = sum(Infected.CD4.500.Plus..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.350.To.499..Not.On.ART. = sum(Infected.CD4.350.To.499..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.200.To.349..Not.On.ART. = sum(Infected.CD4.200.To.349..Not.On.ART.*pop.scaling.factor), 
            Infected.CD4.Under.200..Not.On.ART. = sum(Infected.CD4.Under.200..Not.On.ART.*pop.scaling.factor), 
            .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(
    Infected = mean(Infected),
    On_ART = mean(On_ART),
    N_PLHIV_15_UP_CD4_500_INF = mean(Infected.CD4.500.Plus..Not.On.ART.), 
            N_PLHIV_15_UP_CD4_350_500 = mean(Infected.CD4.350.To.499..Not.On.ART.),
            N_PLHIV_15_UP_CD4_200_350 = mean(Infected.CD4.200.To.349..Not.On.ART.),
            N_PLHIV_15_UP_CD4_050_200 = 7/8*mean(Infected.CD4.Under.200..Not.On.ART.),
            N_PLHIV_15_UP_CD4_000_050 = 1/8*mean(Infected.CD4.Under.200..Not.On.ART.),
  ) %>% 
  ungroup() %>% 
  mutate(method1 = Infected - On_ART,
         method2 = N_PLHIV_15_UP_CD4_500_INF + N_PLHIV_15_UP_CD4_350_500 + 
           N_PLHIV_15_UP_CD4_200_350 + N_PLHIV_15_UP_CD4_050_200 + N_PLHIV_15_UP_CD4_000_050)

noart.summary %>% View
```


# Output

```{r}
flows.table <- rbind(
  inc.summary %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  deaths.summary  %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  ylls.summary %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  testing.summary  %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value)
)

flows.table
```

```{r}
stocks.table <- rbind(
  plhiv.summary %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  pop.summary  %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  diag.summary  %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  onart.summary  %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value),
  cd4.summary %>% 
    filter(Year >=2021, Year<=2050) %>% 
    pivot_longer(-Year) %>% 
    pivot_wider(names_from = Year, values_from = value)
)

stocks.table
```

```{r}
getwd(
)

stocks.table <- read.csv("Analysis/MIHPSA_MWI_output_stocks_EMOD_2024907.csv")

pivot_longer(stocks.table,
             cols = 2021:2050)
```


```{r}
write_csv(flows.table, "Analysis/MIHPSA_MWI_output_flows_EMOD_2024907.csv")

write_csv(stocks.table, "Analysis/MIHPSA_MWI_output_stocks_EMOD_2024907.csv")
```


# Plots for comparison with data

## Read Calibration Target Data 
```{r Read Prevalence data}
# Read in the calibration targets data
prev.target <- read_csv("../calib_targets_data/MalawiNationalPrevalence.csv")

# Convenient relabels of age bins
prev.target$Age = factor(prev.target$AgeBin, 
                         levels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)", "[15:50)"),
                         labels = c(1:11)
                         )

prev.target$Year.label = factor(prev.target$Year, 
                          levels = c(2004.0, 2010.0, 2015.0, 2015.5),
                          labels = c( "2004 (DHS)","2010 (DHS)", "2015 (DHS)", "2015 (PHIA)"))
```

```{r Read Incidence data}
# Using the new Incidence data, which has the right age bins for fair comparison to the reports
inc.target <- read_csv("../calib_targets_data/Malawi_Incidence_new.csv")

inc.target$Year_label = factor(inc.target$Year, levels = c("2015.5", "2020"), labels = c("2015 (PHIA)","2020 (PHIA)"))

inc.target$Age = factor(inc.target$AgeBin, 
                        levels = c("[15:50)", "[15:25)", "[25:35)", "[35:50)"),
                        labels = c(1,2,3,4))

```

```{r Read ART coverage data}
onart.target <- read_csv("calib_targets_data/Malawi_OnART.csv")

#art.cov.target <- read_csv("calib_targets_data/ARTCoverage.csv")
#art.cov.target <- art.cov.target %>% filter(Province=='All')
# art.cov.target$Year.label = factor(art.cov.target$Year, 
#                           levels = c(2004.0, 2010.0, 2015.0, 2015.5),
#                           labels = c( "2004 (DHS)","2010 (DHS)", "2015 (DHS)", "2015 (PHIA)"))

art.cov.target <- read_csv("calib_targets_data/ART_Coverage_PHIA.csv")
art.cov.target$Year = 2015.5
art.cov.target$Year.label = factor(art.cov.target$Year, 
                                   levels = c(2015.5), labels = c("2015 (PHIA)"))

# Convenient relabels of age bins
art.cov.target$Age = factor(art.cov.target$AgeBin, 
                         levels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)", "[15:50)"),
                         labels = c(1:11)
                         )
# Relabel and subset useful columns
art.cov.target <- art.cov.target %>% 
  dplyr::select("Year", "Year.label", "Age", "AgeBin", "Gender" = "gender", "ARTCoverage", "denominator", "confidence_lower", "confidence_upper")
```

## Prevalence plots

### Prevalence

Plot all ages prevalence over time
```{r All ages prevalence plot}
prev.data <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Age >= 15, Age < 49) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = Infected/Population) %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female")) 

prev.plot <- ggplot() +
  # plot ensemble of runs
  geom_point(data = prev.data, mapping = aes(x = Year, y = Prevalence), size = .25, alpha = .1, color = 'gray') + 
  # plot mean
  geom_point(data = prev.data %>% 
               group_by(Year, Gender) %>% 
               summarize(prevalence = mean(Prevalence), .groups = 'keep') , 
             mapping = aes(x = Year, y = prevalence), size = 1, color = 'blue') + 
  # compare to calibration targets
  geom_point(data = prev.target %>% filter(Age == 11), 
             size=2, color = "black", aes(x=Year, y=NationalPrevalence)) + 
  geom_errorbar(data = prev.target %>% filter(Age == 11), 
                aes(x=Year, ymin=lower, ymax=upper), color="black", width=2, size=1) +
  xlab("Year") +
  ylab("Prevalence, ages 15-49") +
  facet_grid(cols = vars(Gender)) + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,.2,0.05), limits=c(0,.20)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  scale_color_manual(values = c("red", "green", "blue"), breaks = c(1,2,3), labels = c("0.005", "0.01","0.05"), name = "Seed Coverage") + 
  theme(legend.position="top") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
prev.plot
```
### Age Prevalence

Plot age prevalence curves
```{r Plot age prevalence curves}
subset_years = c(2015.5, 2010.0, 2004.0, 2015.0)
age_bins = c(15, 20, 25, 30, 35, 40, 45, 50, 55, 60,65)
age_labels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)")

prev.data <- sim.results %>% 
  filter(Age >=15, Age <= 65, Year %in% subset_years) %>% 
  group_by(Year, Age, Gender, sim.ix) %>% 
  summarize(population = sum(Population), infected = sum(Infected), .groups = 'keep') %>% 
  ungroup()

prev.data <- prev.data %>%  
  mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
  filter(!is.na(AgeBin))
prev.data$AgeBin_index = factor(prev.data$AgeBin,
                                    labels = 1:length(age_labels))

prev.data.age <- prev.data %>% 
  group_by(Year, Gender, AgeBin, AgeBin_index) %>% 
  summarize(Population = sum(population),
            Infected = sum(infected), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year, Gender, AgeBin, AgeBin_index) %>% 
  summarize(Population = mean(Population),
            Infected = mean(Infected),
            Prevalence = mean(Prevalence), .groups = "keep") %>%
  ungroup() %>%
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female"))

ap.plot <- ggplot() + 
  geom_point(data = prev.target %>% filter(Age != 11) %>% ungroup(),
           mapping = aes(x = Age, y = NationalPrevalence), color = 'black') +
  geom_errorbar(data = prev.target %>% filter(Age != 11) %>% ungroup(),
                mapping = aes(x=Age, ymin=lower, ymax=upper), color="black", width=.3, size=1) +
  geom_point(
   data = prev.data.age,
    mapping = aes(x = AgeBin_index, y = Prevalence, color = Gender)) +
  facet_grid(cols = vars(Gender), rows = vars(Year)) + 
  scale_x_discrete(breaks = 1:10, 
                   labels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", 
                              "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)")
                     ) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,.35,0.05), limits=c(0,.3)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ap.plot
```


## Incidence Plots
```{r All ages incidence plots}
inc.table <- sim.results %>% 
  filter(Age >=15, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence(gender.breakdown = TRUE) %>% 
  # Still disaggregated by gender, so let's aggregate up
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Newly.Infected = sum(Newly.Infected), pop = sum(`Population - Infected`)) %>% 
  mutate(incidence = Newly.Infected/(pop - Newly.Infected/2)) %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female"))

inc.plot <- ggplot() + 
  # plot the simulation results
  geom_point(data = inc.table, mapping = aes(x = Year, y = incidence), color = 'gray', alpha = .1) +
  geom_line(data = inc.table %>% 
                    group_by(Year, Gender) %>% 
                    summarize(mean.inc.overall = mean(incidence), .groups = 'keep'), 
            mapping = aes(x = Year, y = mean.inc.overall), size = 1, color = "blue") +
  # plot the calibration targets
  geom_point(data = inc.target %>% filter(Age == 1), 
             aes(x=Year, y=Incidence),
             size=2, color = "black") + 
  geom_errorbar(data = inc.target %>% filter(Age == 1), 
                aes(x=Year, ymin=lb, ymax=ub), 
                color="black", width=2, size=1) +
  facet_grid(cols = vars(Gender)) +
  xlab("Year") +
  ylab("Incidence, ages 15-49") +
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = .1), breaks = seq(0,.03,0.005), limits=c(0,.03)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
inc.plot
```

Incidence by age plots
```{r Plot incidence by age}
# Need to bin ages to match the PHIA data
t1 <- sim.results %>% 
  filter(Age >=15, Age < 25) %>% 
  EMODAnalyzeR::calculate.incidence(gender.breakdown = TRUE) %>% 
  # Still disaggregated by gender, so let's aggregate up
  group_by(Year, Gender, sim.id) %>%
  summarize(Newly.Infected = sum(Newly.Infected), pop = sum(`Population - Infected`)) %>% 
  mutate(incidence = Newly.Infected/(pop - Newly.Infected/2)) %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year, Gender) %>% 
  summarize(mean.inc.overall = mean(incidence), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female")) %>% 
  mutate(Age = 2)

t2 <- sim.results %>% 
  filter(Age >=25, Age < 35) %>% 
  EMODAnalyzeR::calculate.incidence(gender.breakdown = TRUE) %>% 
  # Still disaggregated by gender, so let's aggregate up
  group_by(Year, Gender, sim.id) %>%
  summarize(Newly.Infected = sum(Newly.Infected), pop = sum(`Population - Infected`)) %>% 
  mutate(incidence = Newly.Infected/(pop - Newly.Infected/2)) %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year, Gender) %>% 
  summarize(mean.inc.overall = mean(incidence), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female")) %>% 
  mutate(Age = 3)

t3 <- sim.results %>% 
  filter(Age >=35, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence(gender.breakdown = TRUE) %>% 
  # Still disaggregated by gender, so let's aggregate up
  group_by(Year, Gender, sim.id) %>%
  summarize(Newly.Infected = sum(Newly.Infected), pop = sum(`Population - Infected`)) %>% 
  mutate(incidence = Newly.Infected/(pop - Newly.Infected/2)) %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year, Gender) %>% 
  summarize(mean.inc.overall = mean(incidence), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female")) %>% 
  mutate(Age = 4)


inc.age.data <- t1 %>% pivot_wider(id_cols = c("Year", "Gender"), 
                                   names_from = c("Age"), 
                                   values_from = c("mean.inc.overall")) %>% 
  inner_join(t2 %>% pivot_wider(id_cols = c("Year", "Gender"), 
                                names_from = c("Age"), 
                                values_from = c("mean.inc.overall")), 
             by = c("Year", "Gender")) %>% 
  inner_join(t3 %>% pivot_wider(id_cols = c("Year", "Gender"), 
                              names_from = c("Age"), 
                              values_from = c("mean.inc.overall")), 
           by = c("Year", "Gender")) %>% 
  pivot_longer(cols = c( `2`, `3`,`4`), names_to = c("AgeBin"), values_to = c("mean.inc"))

inc.age.plot <- ggplot() + 
  geom_point(data = inc.target %>% filter(Age != 1), 
             mapping = aes(x = Age, y = Incidence)) + 
  geom_errorbar(data = inc.target %>% filter(Age != 1), 
                mapping = aes(x=Age, ymin=lb, ymax=ub), color="black", width=.3, size=1) +
  geom_point(data = inc.age.data %>% filter(Year == 2015) %>% mutate(Year = "2015 (PHIA)"),
             mapping = aes(x = AgeBin, y = mean.inc), color = "blue"
             ) +
  facet_grid(cols = vars(Gender), rows = vars(Year)) + 
  scale_x_discrete(breaks = 2:4, 
                   labels = c("[15:25)", "[25:35)", "[35:50)")
                   ) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = .1), 
                     breaks = seq(0,.0125,0.005), 
                     limits=c(0,.0125)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

inc.age.plot
```


## ART Plots

```{r Number of people on ART}
onart.data <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id, Gender) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female"))
  
onart.plot <- ggplot() + 
  geom_point(data = onart.data, mapping = aes(x = Year, y = On_ART),
             size = 1, alpha = .1, color = 'gray') +
  geom_line(data = onart.data %>%
              group_by(Year, Gender) %>%
              summarize(mean.On_ART.overall = mean(On_ART), 
                        .groups = 'keep'),
            color = 'blue', size = 1,
            mapping = aes(x = Year, y = mean.On_ART.overall)) + 
  geom_point(data = onart.target, 
             mapping = aes(x = Year, y = On_ART)) + 
  geom_errorbar(data = onart.target, 
                mapping = aes(x = Year, ymin = lower, ymax = upper)) + 
  facet_grid(cols = vars(Gender))  + 
  ylab("Numer on ART, Ages 15+")+
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_y_continuous(limits=c(0,750000), breaks = seq(0,750000,250000), expand=c(0,0)) +
  scale_x_continuous(limits = c(2000,2025), breaks = seq(2000,2025,5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

onart.plot
```


ART coverage by age
I am not sure whether the denominator here is supposed to be PLHIV or total population.  I am not able to 
```{r ART coverage by age}

oac.data.age <- sim.results %>% 
  filter(Age >=15, Age < 65, Year == 2015.5) %>% 
  group_by(Year, Age, Gender, sim.id) %>% 
  summarize(oac.pop = sum(On_ART), population = sum(Infected), .groups = 'keep') %>% 
  mutate(onart.coverage = case_when(population <= 0 ~ 0,
                                population > 0 ~ oac.pop/population)) %>% 
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female")) %>% 
  group_by(Year, Age, Gender) %>% 
  summarize(mean.onart.coverage = mean(onart.coverage), .groups = 'keep')

# Need to apply the right labels to the age groups...
oac.data.age$AgeBin <- factor(oac.data.age$Age, 
                     levels = c(15, 20, 25, 30, 35, 40, 45, 50, 55, 60),
                     labels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)")
                     )
oac.data.age$AgeBin.index = oac.data.age$Age/5-2

oac.plot <- ggplot() + 
  geom_point(data = art.cov.target %>% filter(Age != 11) %>% ungroup(),
           mapping = aes(x = Age, y = ARTCoverage/100), color = 'black') +
  geom_errorbar(data = art.cov.target %>% filter(Age != 11) %>% ungroup(),
                mapping = aes(x=Age, ymin=confidence_lower/100, ymax=confidence_upper/100), color="black", width=.3, size=1) +
  geom_point(
    data = oac.data.age %>%
    ungroup() %>%
    group_by(Age, AgeBin, AgeBin.index, Gender, Year) %>%
    filter(Year %in% c(2015.5, 2010.0, 2004.0, 2015.0)),
    mapping = aes(x = AgeBin.index, y = mean.onart.coverage), color = 'blue') +
  facet_grid(cols = vars(Gender), rows = vars(Year)) + 
  scale_x_discrete(breaks = 1:10, 
                   labels = c("[15:20)", "[20:25)", "[25:30)", "[30:35)", "[35:40)", 
                              "[40:45)", "[45:50)", "[50:55)", "[55:60)", "[60:65)")
                     ) + 
  #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,.35,0.05), limits=c(0,.3)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

oac.plot

```

## VMMC 

### Number VMMCs performed
```{r}
vmmc.summary %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = N_NewVMMC)) + 
  theme_bw()
```

### Fraction circumcised

## HIV Testing

```{r}
test.total.counts <- data.table(
  Year = c(2019, 2020, 2021, 2022, 2023),
  tests = c(4060211,	2737333,	2653001,	3006284,	3404438)
)

total.tests.summary %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = mean.Total.Tests)) + 
  geom_point(data = test.total.counts, 
             mapping = aes(x = Year, y = tests))
```
### Positive tests

```{r}
positive.test.total.counts <- data.table(
  Year = c(2019, 2020, 2021, 2022, 2023),
  tests = c(115618,	83849,	77606,	78432,	67129)
)

positive.tests.summary <- sim.results %>% 
  filter(Age >= 15) %>% 
  EMODAnalyzeR::calculate.tests.performed(gender.breakdown = FALSE) %>% 
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>% 
  group_by(Year) %>% 
  summarize(mean.Newly.Tested.Positive = mean(Newly.Tested.Positive*pop.scaling.factor), .groups = 'keep')

ggplot() + 
  geom_line(data = positive.tests.summary, 
            mapping = aes(x = Year, y = mean.Newly.Tested.Positive)) + 
  geom_point(data = positive.test.total.counts, 
             mapping = aes(x = Year, y = tests))
```


### ANC Tests
```{r}

anc.total.counts <- data.table(
  Year = c(2019, 2020, 2021, 2022, 2023),
  tests = c(578497,	575150, 587323,	633819, 693486)
)

anc.summary = sim.results %>% 
  mutate(ANC = HIV_Positive_at_ANC + HIV_Negative_at_ANC_NULL,
         Year = floor(Year)) %>% 
  filter(Gender == 1, Year > 1999) %>% 
  group_by(Year, sim.ix) %>% 
  summarize(ANC = sum(ANC * pop.scaling.factor)) %>% 
  group_by(Year) %>% 
  summarize(ANC = mean(ANC)) 

ggplot() + 
  geom_line(data = anc.summary,
            mapping = aes(x = Year, y = ANC)) + 
  geom_point(data = anc.total.counts, 
             mapping = aes(x = Year, y = tests))

```

# Code Graveyard


## Count number of new HIV infections
This is going to be on a per-year basis, so I will need to use a similar trick here to sum over each pair of observation points for each year. 
This is still an absolute count, so will need to scale up the number newly infected
```{r New Infections}
# Males 15-49
p1 <- sim.results %>% 
  filter(Gender == 0, Age >=15, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.males = mean(Newly.Infected), .groups = 'keep')

# Females 15-24
p2 <- sim.results %>% 
  filter(Gender == 1, Age >=15, Age < 25) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.females.younger = mean(Newly.Infected), .groups = 'keep')

# Females 25-49
p3 <- sim.results %>% 
  filter(Gender == 1, Age >=25, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.females.older = mean(Newly.Infected), .groups = 'keep')

# Overall
p4 <- sim.results %>% 
  filter(Age >=15, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>%
  group_by(Year, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.overall = mean(Newly.Infected), .groups = 'keep')

new.inf.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  mutate(Year = floor(Year)) 

new.inf.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## HIV-caused deaths
Count the number of deaths from HIV
```{r HIV-caused deaths}
# Males 15+ 
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.hivdeaths.males = mean(Died_from_HIV), .groups = 'keep')

# Females 15+
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.hivdeaths.females = mean(Died_from_HIV), .groups = 'keep')

# Children <15
p3 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>%
  group_by(Year, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>%
  group_by(Year) %>% 
  summarize(mean.hivdeaths.children = mean(Died_from_HIV), .groups = 'keep')

# Overall
p4 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>%
  group_by(Year) %>% 
  summarize(mean.hivdeaths.overall = mean(Died_from_HIV), .groups = 'keep')

hiv.deaths.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  mutate(Year = floor(Year))

hiv.deaths.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## All deaths
```{r All-cause deaths}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Died, sim.id, pop.scaling.factor) %>%
  filter(Gender == 0, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.deaths.males = mean(Died), .groups = 'keep')

# Females 15+
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Died, sim.id, pop.scaling.factor) %>%
  filter(Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.deaths.females = mean(Died), .groups = 'keep')

# Overall
p3 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Died, sim.id, pop.scaling.factor) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Died = sum(Died*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.deaths.overall = mean(Died), .groups = 'keep')

deaths.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  mutate(Year = floor(Year)) 

deaths.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## HIV Prevalence
This is calculated at each time step as number infected divided by the population

The MIHPSA 
```{r Prevalence }
# Males 15-24 
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 0, Age >= 15, Age <25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.males.younger = mean(Prevalence), .groups = 'keep')
  
# Males 25-49
p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 0, Age >= 25, Age <50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.males.older = mean(Prevalence), .groups = 'keep')

# Females 15-24
p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 1, Age >= 15, Age <25, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.females.younger = mean(Prevalence), .groups = 'keep')
  
# Females 25-49
p4 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 1, Age >= 25, Age <50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.females.older = mean(Prevalence), .groups = 'keep')

# Children <15
p5 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Age < 15, ceiling(Year) != Year) %>%
  group_by(Year, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>%
  group_by(Year) %>% 
  summarize(mean.prev.children = mean(Prevalence), .groups = 'keep')

# Female Sex Workers
p6 <- sim.results %>% 
  filter(Gender == 1, IP_Key.Risk == 'HIGH') %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(ceiling(Year) != Year) %>%
  group_by(Year, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>%
  group_by(Year) %>% 
  summarize(mean.prev.fsw = mean(Prevalence), .groups = 'keep')


# Overall
p7 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>%
  group_by(Year) %>% 
  summarize(mean.prev.overall = mean(Prevalence), .groups = 'keep')


prev.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  merge(p6, by = 'Year') %>%
  merge(p7, by = 'Year') %>%
  mutate(Year = floor(Year)) 

prev.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## HIV Incidence
The MIHPSA report asks us to calculate the per-100-p-y incidence, but I am not clear on how to get this number out. Is the per-year calculation a per 1 person year? So maybe it's dividing this number by 100?

```{r Incidence}
# Males 15-24
p1 <- sim.results %>% 
  filter(Gender == 0, Age >=15, Age < 25) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year) %>% 
  summarize(mean.inc.males.younger = mean(incidence), .groups = 'keep')

# Males 25-49
p2 <- sim.results %>% 
  filter(Gender == 0, Age >=25, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year) %>% 
  summarize(mean.inc.males.older = mean(incidence), .groups = 'keep')

# Females 15-24
p3 <- sim.results %>% 
  filter(Gender == 1, Age >=15, Age < 25) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year) %>% 
  summarize(mean.inc.females.younger = mean(incidence), .groups = 'keep')

# Females 25-49
p4 <- sim.results %>% 
  filter(Gender == 1, Age >=25, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, incidence) %>% 
  group_by(Year) %>% 
  summarize(mean.inc.females.older = mean(incidence), .groups = 'keep')

# Overall
p5 <- sim.results %>% 
  filter(Age >=15, Age < 50) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  # Still disaggregated by gender, so let's aggregate up
  group_by(Year, sim.id, scenario_name) %>% 
  summarize(Newly.Infected = sum(Newly.Infected), pop = sum(`Population - Infected`)) %>% 
  mutate(incidence = Newly.Infected/(pop - Newly.Infected/2)) %>% 
  dplyr::select(Year, sim.id, incidence) %>% 
  group_by(Year) %>% 
  summarize(mean.inc.overall = mean(incidence), .groups = 'keep')

inc.summary <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>% 
  mutate(Year = floor(Year)) 

inc.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## PLHIV aware of their status
This is people who have been diagnosed - will need to double-check that the "Diagnosed" column from the simulation results reflects a running total of the people who know their HIV status:
```{r Diagnosed}
plhiv.diagnosed.summary <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(PLHIV.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.diagnosed = mean(PLHIV.Diagnosed), .groups = 'keep') %>% 
  mutate(Year = floor(Year)) 

plhiv.diagnosed.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Total tests and fraction of positive tests
Total tests performed = Newly.Tested.Positive + Newly.Tested.Negative
Just as for incidence, I am going to have to combine everything by year. I'll create a function for doing this similar to the one that David made for incidence calculation.

```{r Total Tests Performed Over Age 15}
total.tests.summary <- sim.results %>% 
  filter(Age >= 15) %>% 
  EMODAnalyzeR::calculate.tests.performed(gender.breakdown = TRUE) %>% 
  inner_join(sim.results.pop.scaling, by = c("sim.id")) %>% 
  group_by(Year, Gender) %>% 
  summarize(mean.Total.Tests = mean(Total.Tests*pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Gender_labels = case_when(Gender == 0 ~ "mean.Total.Tests.males", 
                                   Gender == 1 ~ "mean.Total.Tests.females")) %>% 
  pivot_wider(id_cols = Year, 
              names_from = Gender_labels,
              values_from = mean.Total.Tests) %>% 
  mutate(mean.Total.Tests = mean.Total.Tests.males + mean.Total.Tests.females)

total.tests.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value) %>% head
```

### Positive tests
```{r Fraction of positive tests for adults}

positive.tests.summary <- sim.results %>% 
  filter(Age > 15) %>% 
  EMODAnalyzeR::calculate.tests.performed(gender.breakdown = FALSE) %>% 
  group_by(Year) %>% 
  summarize(mean.Proportion.Positive.Tests = mean(Proportion.Positive.Tests))

positive.tests.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```



## PLHIV on ART
Count the number of people on art. Art coverage is the ratio between people on art and PLHIV.

```{r OnART}
# Males Age 15+
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(ART.coverage = case_when(Infected == 0 ~ 0,
                                  Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year) %>% 
  summarize(mean.On_ART.males = mean(On_ART), mean.ART.coverage.males = mean(ART.coverage), .groups = 'keep')

# Females Age 15+
p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(ART.coverage = case_when(Infected == 0 ~ 0,
                                  Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year) %>% 
  summarize(mean.On_ART.females = mean(On_ART), mean.ART.coverage.females = mean(ART.coverage), .groups = 'keep')

# Children
p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age < 15, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>%   
  mutate(ART.coverage = case_when(Infected == 0 ~ 0,
                                  Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year) %>% 
  summarize(mean.On_ART.children = mean(On_ART), mean.ART.coverage.children = mean(ART.coverage), .groups = 'keep')

# Total
p4 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(ART.coverage = case_when(Infected == 0 ~ 0,
                                  Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year) %>% 
  summarize(mean.On_ART.overall = mean(On_ART), mean.ART.coverage.overall = mean(ART.coverage), .groups = 'keep')


onart.data <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>% 
  mutate(Year = floor(Year)) 

onart.summary <- onart.data %>% select(Year, mean.On_ART.males, mean.On_ART.females, mean.On_ART.children, mean.On_ART.overall)

onart.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

```{r Art Coverage}
art.coverage.summary <- onart.data %>% 
  select(Year, mean.ART.coverage.males, mean.ART.coverage.females, 
         mean.ART.coverage.children, mean.ART.coverage.overall)

art.coverage.summary %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```


## VMMC

Fraction of males aged 15-49 who have been circumcised

Given that the data only seem to count people after 2015, which is when the VMMC program started in Malawi, 
```{r Circumcision fraction}
circumcision.summary <- sim.results %>% 
  dplyr::select(Year, Gender, Age, IsCircumcised, Population, sim.id) %>%
  filter(Gender == 0, Age >= 15, Age < 50, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id, IsCircumcised) %>% 
  summarize(Population = sum(Population), .groups = 'keep') %>% 
  mutate(IsCircumcised.status = case_when(IsCircumcised == 0 ~ 'No', IsCircumcised == 1 ~ 'Yes')) %>% 
  pivot_wider(id_cols = c(Year, sim.id), names_from = IsCircumcised.status, values_from = Population) %>% 
  mutate(fraction.circumcised = Yes/(No + Yes)) %>% 
  group_by(Year) %>% 
  summarize(mean.fraction.circumcised = mean(fraction.circumcised), .groups = 'keep') %>% 
  mutate(Year = floor(Year)) 

circumcision.summary  %>% 
  pivot_longer(-Year) %>% 
  pivot_wider(names_from = Year, values_from = value)
```

## Save everything as a csv:
```{r Output as csv}
rbind(pop.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # population
      plhiv.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # plhiv
      new.inf.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # new hiv infections
      hiv.deaths.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # hiv deaths
      deaths.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # total deaths
      prev.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # prevalence
      inc.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # incidence
      plhiv.diagnosed.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # plhiv aware of their status
      total.tests.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # total tests performed
      positive.tests.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # positive tests performed
      onart.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # number of plhiv on art
      art.coverage.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value), # art coverage summary
      circumcision.summary %>% pivot_longer(-Year) %>% pivot_wider(names_from = Year, values_from = value) # circumcisions
) %>% 
  write.csv(file = '/gpfs/data/bershteynlab/EMOD/citrod01/MWI_calib_original_20220122/MWI_MIHPSA/MIHPSA_results_report.csv')
```


