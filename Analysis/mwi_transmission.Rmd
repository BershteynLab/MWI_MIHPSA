---
title: "mwi_transmission"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook is to figure out how to examine the transmission events in the Malawi EMOD model.

```{r Load libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```

# Read summary report

The summary report we need for a few things. 

First, we need to know the population scaling factor. 

Second, we also will need to know a few baseline things:

  * Size of age 15-64 population at mid-year (men, women, total)
  * HIV prevalence among 15-64 population at mid-year (men, women, total)
  * New HIV infections age 15-64 (men, women, total)
  * Proportion diagnosed at age 15-64 (men, women, total)
  * Of those diagnosed, % on ART (men, women, total)
  * Of those on art, what percent virally suppressed (92%)
  
```{r Load Report Data}
input_path = "/gpfs/scratch/citrod01/experiments/Malawi/Baseline-campaign_Malawi_20220422_recalib-transmission___2023_11_04_11_30_19_157590"

sim.results <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = input_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive", "Newly.Tested.Negative",
                        "Population","Infected", "On_ART","Died", "Died_from_HIV",
                        "Tested.Past.Year.or.On_ART", "Tested.Ever","Diagnosed" ),
  stratify_columns = c("Year", "Gender", "Age"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
) %>% 
  ungroup()

```

```{r Population rescaling factor}
CENSUS_YEAR = 2018.5
MALAWI_CENSUS_POP = 17563749

sim.results.pop.scaling <- sim.results %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = MALAWI_CENSUS_POP/total.pop)

sim.results.pop.scaling$sim.id.ix <- 1:nrow(sim.results.pop.scaling)

sim.results <- sim.results %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
sim.results$sim.id <- sim.results$sim.id.ix
sim.results$sim.id.ix <- NULL

```

# Epidemiological measurements

Here we measure the basic aspects of the outbreak

## Population

```{r Population}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.id, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15, Age < 65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  # remember to rescale by population scaling factor!
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.pop.males = mean(Population), .groups = 'keep')

# Females 15+
p2 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.id, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15, Age < 65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.pop.females = mean(Population), .groups = 'keep')


# Overall
p3 <-sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, sim.id, pop.scaling.factor) %>%
  filter(Age >= 15, Age < 65, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.pop.overall = mean(Population), .groups = 'keep')

baseline.comp.data <- merge(p1, p2, by = c("Year")) %>% 
  merge(p3, by = c("Year"))
```

## Prevalence 

```{r Prevalence data}
# Males
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 0, Age >= 15, Age <65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.males = mean(Prevalence), .groups = 'keep')

# Females 
p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Gender == 1, Age >= 15, Age <65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.females = mean(Prevalence), .groups = 'keep')

# Overall
p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Population, Infected, sim.id) %>%
  filter(Age >= 15, Age <65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  mutate(Prevalence = Infected/Population) %>% 
  group_by(Year) %>% 
  summarize(mean.prev.overall = mean(Prevalence), .groups = 'keep')

baseline.comp.data <- merge(baseline.comp.data, p1, by = c("Year")) %>% 
  merge(p2, by = c("Year")) %>% 
  merge(p3, by = c("Year"))
```

## New HIV Infections

```{r New HIV Infections}
# Males 
p1 <- sim.results %>% 
  filter(Gender == 0, Age >=15, Age < 65) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id" = "sim.id.ix")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections = mean(Newly.Infected), .groups = 'keep')

# Females
p2 <- sim.results %>% 
  filter(Gender == 1, Age >=15, Age < 65) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id" = "sim.id.ix")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.females = mean(Newly.Infected), .groups = 'keep')

# Overall
p3 <- sim.results %>% 
  filter(Age >=15, Age < 65) %>% 
  EMODAnalyzeR::calculate.incidence() %>% 
  dplyr::select(Year, Gender, sim.id, Newly.Infected) %>% 
  # rescale by population scale factor
  inner_join(sim.results.pop.scaling, by = c("sim.id" = "sim.id.ix")) %>%
  group_by(Year, Gender, sim.id) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year) %>% 
  summarize(mean.new.infections.overall = mean(Newly.Infected), .groups = 'keep')

p1$Year = p1$Year + .5
p2$Year = p2$Year + .5
p3$Year = p3$Year + .5

baseline.comp.data <- merge(baseline.comp.data, p1, by = c("Year")) %>% 
  merge(p2, by = c("Year")) %>% 
  merge(p3, by = c("Year"))
```

## Diagnosed 
```{r Proportion diagnosed}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 0, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(PLHIV.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.diagnosed.males = mean(PLHIV.Diagnosed), .groups = 'keep')

p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(PLHIV.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.diagnosed.females = mean(PLHIV.Diagnosed), .groups = 'keep')

p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(PLHIV.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.diagnosed.overall = mean(PLHIV.Diagnosed), .groups = 'keep')

baseline.comp.data <- merge(baseline.comp.data, p1, by = c("Year")) %>% 
  merge(p2, by = c("Year")) %>% 
  merge(p3, by = c("Year"))
``` 

## ART
```{r Percent diagnosed on ART}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Diagnosed, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 0, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), On_ART = sum(On_ART*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(OnART.Diagnosed = case_when(On_ART == 0 ~ 0,
                                     On_ART > 0 ~ On_ART/Diagnosed) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.onart.males = mean(OnART.Diagnosed), .groups = 'keep')

p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(OnART.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.onart.females = mean(OnART.Diagnosed), .groups = 'keep')

p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Diagnosed, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, sim.id) %>% 
  summarize(Diagnosed = sum(Diagnosed*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(OnART.Diagnosed = case_when(Infected == 0 ~ 0,
                                     Infected > 0 ~ Diagnosed/Infected) ) %>%
  group_by(Year) %>% 
  summarize(mean.plhiv.onart.overall = mean(OnART.Diagnosed), .groups = 'keep')

baseline.comp.data <- merge(baseline.comp.data, p1, by = c("Year")) %>% 
  merge(p2, by = c("Year")) %>% 
  merge(p3, by = c("Year"))
```

## Save output
```{r Save baseline output}
write_excel_csv(baseline.comp.data, "transmission_baseline_comp_data.csv")
```

## Additional analysis

### Proportion of new infections by age group
What is the proportion of new infections by age group?

```{r}
subset.years = c(2010, 2020, 2030, 2040)

data <- sim.results %>% filter(Year %in% subset.years)

data %>% group_by(Year, Gender, Age, sim.ix) %>% 
  summarize(Newly.Infected = sum(Newly.Infected*pop.scaling.factor)) %>% 
  group_by(Year, Gender, Age) %>% 
  summarize(Newly.Infected = mean(Newly.Infected)) %>% 
  ungroup() %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Age, y = Newly.Infected)) + 
  facet_grid(cols = vars(Gender), rows = vars(Year))

```

### Percentage on ART in each age group
What is the percentage on ART in each age group?

```{r}
data <- sim.results %>% 
  dplyr::select(Year, Gender, Age, On_ART, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 65, ceiling(Year) != Year) %>% 
  group_by(Year, Gender, Age, sim.id) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), On_ART = sum(On_ART*pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(OnART.Infected = case_when(On_ART == 0 ~ 0,
                                     On_ART > 0 ~ On_ART/Infected) ) %>%
  group_by(Year, Gender, Age) %>% 
  summarize(mean.plhiv.onart.males = mean(OnART.Infected), .groups = 'keep') %>% 
  ungroup()

data %>% filter(Year %in% c(2010.5, 2020.5, 2030.5, 2040.5))

```

### HIV Mortality

One last thing to do: the mortality tables do need two additional columns: total number of HIV deaths and total hiv population at mid year
Total, men, and women
```{r PLHIV by age and year}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 85, Gender == 0, ceiling(Year) != Year) %>% 
  group_by(Year, Age, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year, Age) %>% 
  summarize(mean.plhiv.males = mean(Infected), .groups = 'keep')

p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 85, Gender == 1, ceiling(Year) != Year) %>% 
  group_by(Year, Age, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year, Age) %>% 
  summarize(mean.plhiv.females = mean(Infected), .groups = 'keep')

p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Infected, sim.id, pop.scaling.factor) %>%
  filter(Age >=15, Age < 85, ceiling(Year) != Year) %>% 
  group_by(Year, Age, sim.id) %>% 
  summarize(Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  group_by(Year, Age) %>% 
  summarize(mean.plhiv.total = mean(Infected), .groups = 'keep')

dat.plhiv <- p3  %>%
  merge(p1, by = c("Year", "Age") ) %>% 
  merge(p2, by = c("Year", "Age")) %>% 
  arrange(Age, Year)
```


```{r Total deaths by age and year}
p1 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Gender == 0, Age >= 15) %>% 
  mutate(Year.pair = ceiling(Year)) %>% 
  group_by(Year.pair, Age, Gender, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Year = Year.pair - 1) %>%
  group_by(Year, Age) %>% 
  summarize(mean.hivdeaths.males = mean(Died_from_HIV), .groups = 'keep')

p2 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Gender == 1, Age >= 15) %>% 
  mutate(Year.pair = ceiling(Year)) %>% 
  group_by(Year.pair, Age, Gender, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Year = Year.pair - 1) %>%
  group_by(Year, Age) %>% 
  summarize(mean.hivdeaths.females = mean(Died_from_HIV), .groups = 'keep')

p3 <- sim.results %>% 
  dplyr::select(Year, Gender, Age, Died_from_HIV, sim.id, pop.scaling.factor) %>%
  filter(Age >= 15) %>% 
  mutate(Year.pair = ceiling(Year)) %>% 
  group_by(Year.pair, Age, sim.id) %>% 
  # Rescale by population scaling factor
  summarize(Died_from_HIV = sum(Died_from_HIV*pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Year = Year.pair - 1) %>%
  group_by(Year, Age) %>% 
  summarize(mean.hivdeaths.total = mean(Died_from_HIV), .groups = 'keep')

dat.hivdeaths <- p3  %>%
  merge(p1, by = c("Year", "Age") ) %>% 
  merge(p2, by = c("Year", "Age")) %>% 
  arrange(Age, Year)
```

# Analysis of Transmission Reports Data

## Read Event Reports and Transmission Reports
```{r For formatting the mortality data set}
year.age.sex = full_join(
  data.frame(Tr_year_binned = 2000:2045),
  data.frame(Gender = c(0,1)),
  by = character()
) %>% 
  full_join(data.frame(Age_bin = seq(15,80,5)),
            by = character())
```

```{r Look at Transmissions Report}
folder.list = Sys.glob(paste0(input_path, "/Simulation_*"))

i = 1
f <- paste(folder.list[i], "output/TransmissionReport.csv", sep="/")
tr.report <- fread(f, check.names = TRUE)

tr.data <- tr.report %>% 
  mutate(Tr_year_binned = floor(YEAR),
                     Age_bin = floor(SRC_AGE/365/5)*5) %>% 
  mutate(CD4_count_current_binned = case_when(SRC_CD4 < 200 ~ 0, SRC_CD4 >= 200 ~ 1)) %>% 
  mutate(Tr_event_ix = row_number()) %>% 
  select(Tr_year_binned, Tr_event_ix, Tr_year = YEAR, Age_bin, id = SRC_ID, Gender = SRC_GENDER, Age = SRC_AGE, 
         CD4_count_current_binned, VL = SRC_VIRAL_LOAD, SRC_STAGE,
         SIM_TIME)

tr.data %>% head
```

Event report: all the times when people are diagnosed
```{r Look at Event Report}
folder.list = Sys.glob(paste0(input_path, "/Simulation_*"))

i = 1
f <- paste(folder.list[i], "output/ReportEventRecorder.csv", sep="/")
event.report <- fread(f, check.names = TRUE)

# filter by year, only keep HIV Diagnosis events
event.report <- event.report %>% filter(Year >= 2000, Event_Name == "HIVNewlyDiagnosed")

# keep the first time someone is diagnosed, although I'm pretty sure this can only happen once
event.report <- event.report %>% arrange(Year) %>% group_by(Individual_ID) %>% slice(1) %>% ungroup()

event.report <- event.report %>% mutate(Age_Year = Age/365)
event.report <- event.report %>% mutate(CD4_binned = case_when(CD4 < 200 ~ 0, CD4 >= 200 ~ 1))

event.report <- event.report %>% select(Individual_ID, Gender, 
                        Year, Age_Year, 
                        Event_Name, 
                        HasHIV, OnART, CD4_binned,
                        Infected, Infectiousness, InterventionStatus, Event_Name)
head(event.report)
```

Use ART Report to look for ART init and dropout events
```{r Look at ART Report}
f <- paste(folder.list[i], "output/ReportHIVART.csv", sep="/")
art.report <- fread(f, check.names = TRUE)

art.report <- art.report %>% select(Individual_ID = ID, Age, Gender, CD4, Year, StartingART) %>%
  mutate(event = case_when(StartingART == 1 ~ "InitART", StartingART == 0 ~ "DropOut"))

head(art.report)
```

# Define functions

Each of these functions will be used later to fill out the table of sources of transmissions

## Undiagosed

```{r Undiagnosed}
# Need to know all the people who transmitted before they got diagnosed
# Find set of all transmissions
# Find set of all transmissions that happened after diagnosis
# Subtract.

fun.undiag = function(tr.data, event.report, year.age.sex){
  p1 <- tr.data %>% 
  filter(Tr_year_binned >= 2000) %>% 
  group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("n_all" = n)

  p2 <- left_join(
    tr.data %>% filter(Tr_year_binned >= 2000),
    event.report %>% select(-"Gender"),
    by = c("id" = "Individual_ID")
  ) %>% 
    filter(Tr_year > Year) %>% 
    filter(Event_Name == 'HIVNewlyDiagnosed') %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("n_diag" = n)
  
  p <- merge(
    left_join(
      year.age.sex,
      p1,
      by = c("Tr_year_binned", "Age_bin", "Gender")
    ) %>% replace_na(list(n_all = 0)),
    left_join(
      year.age.sex,
      p2,
      by = c("Tr_year_binned", "Age_bin", "Gender")
    ) %>% replace_na(list(n_diag = 0)),
    by = c("Tr_year_binned", "Age_bin", "Gender")
  ) %>% mutate(Undiagnosed = n_all - n_diag)


  dat.undiagnosed <- p %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(Undiagnosed), 
                names_prefix = 'Undiagnosed.', names_sep = '') %>%
    mutate(Undiagnosed.total = Undiagnosed.m + Undiagnosed.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  return(dat.undiagnosed)
}

# dat.undiagnosed = fun.undiag(tr.data, event.report, year.age.sex)
# 
# dat.undiagnosed %>% head
```

## Diagnosed, not on ART 

```{r Diagnosed without ART}
# Find the set of all transmissions after diagnosis
# Find set of all transmissions after diagnosis and after ANY ART init 
# Subtract
# This isn't working because we have negatives. What am I doing wrong? Need to take the first time someone inits art only

fun.diag.noart = function(tr.data, event.report, year.age.sex){
  p0 <- left_join(
    tr.data %>% filter(Tr_year_binned >= 2000),
    event.report %>% select(-"Gender"),
    by = c("id" = "Individual_ID")
  ) 
  
  p1 <- p0 %>% 
    filter(Tr_year > Year) %>% 
    filter(Event_Name == 'HIVNewlyDiagnosed') %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("n_diag" = n)
  
  p2 <- left_join(
    tr.data %>% filter(Tr_year_binned >= 2000),
    art.report %>% filter(event == "InitART") %>% select(-c(Gender, Age)) %>% rename("ArtYear" = Year),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    # take first time someone gets art 
    arrange(Tr_year_binned, ArtYear) %>% 
    group_by(Tr_event_ix) %>% slice(1) %>% ungroup() %>% 
    filter(Tr_year > ArtYear) %>%
    # count
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("n_art" = n)
  
  p <- merge(
    left_join(
      year.age.sex,
      p1,
      by = c("Tr_year_binned", "Age_bin", "Gender")
    ) %>% replace_na(list(n_diag = 0)),
    left_join(
      year.age.sex,
      p2,
      by = c("Tr_year_binned", "Age_bin", "Gender")
    ) %>% replace_na(list(n_art = 0)),
    by = c("Tr_year_binned", "Age_bin", "Gender")
  ) %>% mutate(Diagnosed_noART = n_diag - n_art)
  
  dat.diagnosed.noART <- p %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(Diagnosed_noART), 
                names_prefix = 'Diagnosed_noART.', names_sep = '') %>%
    mutate(Diagnosed_noART.total = Diagnosed_noART.m + Diagnosed_noART.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  return(dat.diagnosed.noART)
}

# dat.diagnosed.noART <- fun.diag.noart(tr.data, event.report, year.age.sex)
# 
# dat.diagnosed.noART %>% head

```

## On ART less than 6 months after first ART initiation
Stratify by CD4 count

```{r On art less than 6 mos after first init by cd4 count}
# number all initiations grouped by id; take only the first one for each person
# number all dropouts grouped by id; take only the first one for each person
# join with tr.data
# remove events that happened after transmission

fun.onart.under6mo.firstinit <- function(tr.data, art.report, year.age.sex){
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report %>% 
      group_by(Individual_ID, event) %>%
      arrange(Year) %>% slice(1) %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender),
                  names_from = c(event),
                  values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID")
  ) %>% filter((Tr_year > Year_InitART))
  
  # filter on artinit happening more recently than dropout
  # filter on whether artinit happened within 6 months
  
  # filter on CD4 under 200
  p1 <- p %>% 
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    filter(Tr_year - Year_InitART <= .5) %>%
    filter(CD4_InitART < 200) %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("Onart.under6mo.firstinit.under200" = n)
  
  p1 <- left_join(
    year.age.sex,
    p1,
    by = c("Tr_year_binned", "Age_bin", "Gender")
  ) %>% replace_na(list(Onart.under6mo.firstinit.under200 = 0))
  
  
  # filter on CD4 over 200
  p2 <- p %>% 
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    filter(Tr_year - Year_InitART <= .5) %>%
    filter(CD4_InitART >= 200) %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("Onart.under6mo.firstinit.over200" = n)
  
  p2 <- left_join(
    year.age.sex,
    p2,
    by = c("Tr_year_binned", "Age_bin", "Gender")
  ) %>% replace_na(list(Onart.under6mo.firstinit.over200 = 0))
  
  # merge together
  dat.Onart.under6mo.firstinit <- p1 %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(Onart.under6mo.firstinit.under200), 
                names_prefix = 'Onart.under6mo.firstinit.under200.', names_sep = '') %>%
    mutate(Onart.under6mo.firstinit.under200.total = Onart.under6mo.firstinit.under200.m + Onart.under6mo.firstinit.under200.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  dat.onart.under6mo.firstinit <- 
    merge(
      dat.Onart.under6mo.firstinit,
      p2 %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
        pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                    names_from = c(gcode), 
                    values_from = c(Onart.under6mo.firstinit.over200), 
                    names_prefix = 'Onart.under6mo.firstinit.over200.', names_sep = '') %>%
        mutate(Onart.under6mo.firstinit.over200.total = Onart.under6mo.firstinit.over200.m + Onart.under6mo.firstinit.over200.f) %>% 
        arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4)),
      by = c("Tr_year_binned", "Age_bin")
    )
  
  return(dat.onart.under6mo.firstinit)
}

# dat.onart.under6mo.firstinit = fun.onart.under6mo.firstinit(tr.data, art.report, year.age.sex)
# 
# dat.onart.under6mo.firstinit %>% head
```

## On ART less than 6 months after ART re-initiation

Stratify by CD4 count

```{r OnART less than six months after re-initiation by CD4}
# "After interruption, on ART <6 months after last re-initiation, last re-initiated with CD4 <200"

# look for all people who re-initiated ART after dropout
# index initiations and dropouts grouped by id; 
# group by id and index, pivot wider (can associate the n+1th initiation with the nth dropout)
# join with tr.data
# remove events that happened after transmission
# filter on artinit happening more recently than dropout
# filter on whether artinit happened within 6 months

fun.onart.under6mo.reinit <- function(tr.data, art.report, year.age.sex){
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report %>% 
      arrange(Year) %>% 
      group_by(Individual_ID, event) %>% 
      mutate(event_ix = row_number()) %>% filter(event_ix > 1) %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% filter((Tr_year > Year_InitART))
  
  p <- p %>% 
    # find most recent initiation
    group_by(id, Tr_event_ix) %>%
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # filter out cases where dropout hasn't happened yet
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    arrange(Tr_year_binned, id)
  
  # filter on CD4 under 200
  p1 <- p %>% 
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    filter(Tr_year - Year_InitART <= .5) %>%
    filter(CD4_InitART < 200) %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("OnART.afterInterrupt.under6mo.under200" = n)
  
  p1 <- left_join(year.age.sex, p1, 
                  by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(OnART.afterInterrupt.under6mo.under200 = 0))
  
  # filter on CD4 over 200
  p2 <- p %>% 
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    filter(Tr_year - Year_InitART <= .5) %>%
    filter(CD4_InitART >= 200) %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("OnART.afterInterrupt.under6mo.over200" = n)
  
  p2 <- left_join(year.age.sex, p2, 
                  by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(OnART.afterInterrupt.under6mo.over200 = 0))
  
  # merge together
  dat.Onart.under6mo.afterinterrupt <- p1 %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(OnART.afterInterrupt.under6mo.under200), 
                names_prefix = 'OnART.afterInterrupt.under6mo.under200.', names_sep = '') %>%
    mutate(OnART.afterInterrupt.under6mo.under200.total = OnART.afterInterrupt.under6mo.under200.m + OnART.afterInterrupt.under6mo.under200.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  dat.onart.under6mo.reinit <- 
    merge(
      dat.Onart.under6mo.afterinterrupt,
      p2 %>% mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
        pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                    names_from = c(gcode), 
                    values_from = c(OnART.afterInterrupt.under6mo.over200), 
                    names_prefix = 'OnART.afterInterrupt.under6mo.over200.', names_sep = '') %>%
        mutate(OnART.afterInterrupt.under6mo.over200.total = OnART.afterInterrupt.under6mo.over200.m + OnART.afterInterrupt.under6mo.over200.f) %>% 
        arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4)),
      by = c("Tr_year_binned", "Age_bin")
    )
  
  return(dat.onart.under6mo.reinit)
}

# dat.onart.under6mo.reinit <- fun.onart.under6mo.reinit(tr.data, art.report, year.age.sex)
# 
# dat.onart.under6mo.reinit %>% head()
```

## On ART stratify by Viral Load

```{r On ART by VL}
# look for all initiations and dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on artinit happening more recently than dropout

fun.onart.vl <- function(tr.data, art.report, year.age.sex){
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report %>% 
      arrange(Year) %>% 
      group_by(Individual_ID, event) %>% 
      mutate(event_ix = row_number()) %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_InitART)) %>% 
    # take most recent art initiation
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # remove cases where dropout happened more recently
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("OnART" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(OnART = 0))
  
  dat.onart.vl <- p1 %>% 
    mutate(OnART.VL.Supp =  .08 * OnART, OnART.VL.NoSupp = .92 * OnART) %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(OnART.VL.Supp, OnART.VL.NoSupp), names_sep = '.') %>% 
    mutate(OnART.VL.Supp.total = OnART.VL.Supp.m + OnART.VL.Supp.f, OnART.VL.NoSupp.total = OnART.VL.NoSupp.m + OnART.VL.NoSupp.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,7,3,4,8,5,6))
  
  return(dat.onart.vl)
}

# dat.onart.vl <- fun.onart.vl(tr.data, art.report, year.age.sex)
# 
# dat.onart.vl %>% head()
#  
```

## On ART less than 6 months, stratify by viral load
```{r Onart under 6mo by VL}
# look for all initiations and dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on artinit happening more recently than dropout
# filter on under 6 months

fun.onart.under6mo.vl <- function(tr.data, art.report, year.age.sex){
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report %>% 
      arrange(Year) %>% 
      group_by(Individual_ID, event) %>% 
      mutate(event_ix = row_number()) %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_InitART)) %>% 
    # take most recent art initiation
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # remove cases where dropout happened more recently
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    # select only under 6 months
    filter(Tr_year - Year_InitART <= .5) %>% 
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("OnART" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(OnART = 0))
  
  dat.onart.under.6mo.vl <- p1 %>% 
    mutate(OnART.under6mo.VL.Supp = .92 * OnART, OnART.under6mo.VL.NoSupp = .08 * OnART) %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(OnART.under6mo.VL.Supp, OnART.under6mo.VL.NoSupp), names_sep = '.') %>% 
    mutate(OnART.under6mo.VL.Supp.total = OnART.under6mo.VL.Supp.m + OnART.under6mo.VL.Supp.f, 
           OnART.under6mo.VL.NoSupp.total = OnART.under6mo.VL.NoSupp.m + OnART.under6mo.VL.NoSupp.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,7,3,4,8,5,6))
  
  return(dat.onart.under.6mo.vl)
}

# dat.onart.under.6mo.vl = fun.onart.under6mo.vl(tr.data, art.report, year.age.sex)
# 
# dat.onart.under.6mo.vl %>% head()

```

## On ART more than 6 months, stratify by viral load

```{r Onart over 6mo by VL}
# look for all initiations and dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on artinit happening more recently than dropout
# filter on over 6 months

fun.onart.over6mo.vl <- function(tr.data, art.report, year.age.sex){
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report %>% 
      arrange(Year) %>% 
      group_by(Individual_ID, event) %>% 
      mutate(event_ix = row_number()) %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_InitART)) %>% 
    # take most recent art initiation
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # remove cases where dropout happened more recently
    filter((is.na(Year_DropOut) | (Tr_year < Year_DropOut))) %>% 
    # select only over 6 months
    filter(Tr_year - Year_InitART > .5) %>% 
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("OnART" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(OnART = 0))
  
  dat.onart.over.6mo.vl <- p1 %>% 
    mutate(OnART.over6mo.VL.Supp = .92 * OnART, OnART.over6mo.VL.NoSupp = .08 * OnART) %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(OnART.over6mo.VL.Supp, OnART.over6mo.VL.NoSupp), names_sep = '.') %>% 
    mutate(OnART.over6mo.VL.Supp.total = OnART.over6mo.VL.Supp.m + OnART.over6mo.VL.Supp.f, 
           OnART.over6mo.VL.NoSupp.total = OnART.over6mo.VL.NoSupp.m + OnART.over6mo.VL.NoSupp.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,7,3,4,8,5,6))
  
  return(dat.onart.over.6mo.vl)
}

# dat.onart.over.6mo.vl <- fun.onart.over6mo.vl(tr.data, art.report, year.age.sex)
# 
# dat.onart.over.6mo.vl %>% head()

```

## Dropped out of ART

```{r Dropped out of ART}
# look for all initiations and dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on dropout happening more recently than artinit

fun.dropout.all <- function(tr.data, art.report, year.age.sex){
  art.report.dropout <- art.report %>% 
    arrange(Year) %>% 
    group_by(Individual_ID, event) %>% 
    mutate(event_ix = row_number())
  # pair each dropout event with the subsequent art init event
  art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix = art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix +1
  
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report.dropout %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_DropOut)) %>% 
    # take most recent dropout
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # remove cases where InitART happened more recently
    filter((is.na(Year_InitART) | (Tr_year < Year_InitART))) %>% 
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("DropOut" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(DropOut = 0))
  
  dat.dropout <- p1 %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(DropOut), 
                names_prefix = 'DropOut.', names_sep = '.') %>% 
    mutate(DropOut.total = DropOut.m + DropOut.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))

  
  return(dat.dropout)
}

# dat.dropout <- fun.dropout.all(tr.data, art.report, year.age.sex)
# 
# dat.dropout %>% head()

```

## Dropped out of ART, first ART interruption only
```{r Dropped out of ART first interruption only}
# look for all initiations and dropouts; number dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on dropout happening more recently than artinit
# filter on dropout being the first time

fun.dropout.first <- function(tr.data, art.report, year.age.sex){
  art.report.dropout <- art.report %>% 
    arrange(Year) %>% 
    group_by(Individual_ID, event) %>% 
    mutate(event_ix = row_number())
  # pair each dropout event with the subsequent art init event
  art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix = art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix +1
  
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report.dropout %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_DropOut)) %>% 
    # take most recent dropout
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # take first dropout only
    filter(event_ix == 2) %>%
    # remove cases where InitART happened more recently
    filter((is.na(Year_InitART) | (Tr_year < Year_InitART))) %>% 
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("DropOut.first" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(DropOut.first = 0))
  
  dat.dropout.first <- p1 %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(DropOut.first), 
                names_prefix = 'DropOut.first.', names_sep = '.') %>% 
    mutate(DropOut.first.total = DropOut.first.m + DropOut.first.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  return(dat.dropout.first)
}

# dat.dropout.first <- fun.dropout.first(tr.data, art.report, year.age.sex)
# 
# dat.dropout.first %>% head
``` 

## Dropped out of ART, 2nd+ interruption, less than 6 months
```{r Dropped out of ART subsequent interruption only less than 6 months}
# look for all initiations and dropouts; number dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on dropout happening more recently than artinit
# filter on dropout being the after the first time
# filter on under 6 months since dropout

fun.dropout.subseq.under6 <- function(tr.data, art.report, year.age.sex){
  art.report.dropout <- art.report %>% 
    arrange(Year) %>% 
    group_by(Individual_ID, event) %>% 
    mutate(event_ix = row_number())
  # pair each dropout event with the subsequent art init event
  art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix = art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix +1
  
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report.dropout %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_DropOut)) %>% 
    # take most recent dropout before the transmission
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # take any subsequent dropout
    filter(event_ix > 2) %>%
    # remove cases where InitART happened more recently
    filter((is.na(Year_InitART) | (Tr_year < Year_InitART))) %>% 
    # filter on under 6 months since last interruption
    filter(Tr_year - Year_DropOut <= .5) %>%
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("DropOut.subseq.under6mo" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(DropOut.subseq.under6mo = 0))
  
  dat.dropout.subseq.under6mo <- p1 %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(DropOut.subseq.under6mo), 
                names_prefix = 'DropOut.subseq.under6mo.', names_sep = '.') %>% 
    mutate(DropOut.subseq.under6mo.total = DropOut.subseq.under6mo.m + DropOut.subseq.under6mo.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  return(dat.dropout.subseq.under6mo)
}

# dat.dropout.subseq.under6mo <- fun.dropout.subseq.under6(tr.data, art.report, year.age.sex)
# 
# dat.dropout.subseq.under6mo %>% head()
``` 

## Dropped out of ART, 2nd+ interruption, more than 6 months

```{r Dropped out of ART subsequent interruption only more than 6 months} 
# look for all initiations and dropouts; number dropouts
# join with tr.data
# remove events that happened after transmission
# take the 2 most recent events
# pivot wider for each tr event
# filter on dropout happening more recently than artinit
# filter on dropout being the after the first time
# filter on under 6 months since dropout

fun.dropout.subseq.over6 <- function(tr.data, art.report, year.age.sex){
  art.report.dropout <- art.report %>% 
    arrange(Year) %>% 
    group_by(Individual_ID, event) %>% 
    mutate(event_ix = row_number())
  # pair each dropout event with the subsequent art init event
  art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix = art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix +1
  
  p <- inner_join(
    tr.data %>% select(Tr_year_binned, Tr_event_ix, Tr_year, id, Age_bin, Age),
    art.report.dropout %>% 
      pivot_wider(id_cols = c(Individual_ID, Gender, event_ix),
                    names_from = c(event),
                    values_from = c(Year, Age, CD4)),
    by = c("id" = "Individual_ID"),
    relationship = "many-to-many"
  ) %>% 
    filter((Tr_year > Year_DropOut)) %>% 
    # take most recent dropout before the transmission
    group_by(Tr_event_ix, id) %>% 
    filter(event_ix == max(event_ix)) %>% ungroup() %>% 
    # take any subsequent dropout
    filter(event_ix > 2) %>%
    # remove cases where InitART happened more recently
    filter((is.na(Year_InitART) | (Tr_year < Year_InitART))) %>% 
    # filter on under 6 months since last interruption
    filter(Tr_year - Year_DropOut > .5) %>%
    arrange(Tr_year_binned, id)
  
  p1 <- p %>% 
    group_by(Tr_year_binned, Age_bin, Gender) %>% count() %>% rename("DropOut.subseq.over6mo" = n)
  
  p1 <- left_join(year.age.sex, p1, by = c("Tr_year_binned", "Age_bin", "Gender")) %>% 
    replace_na(list(DropOut.subseq.over6mo = 0))
  
  dat.dropout.subseq.over6mo <- p1 %>% 
    mutate(gcode = case_when(Gender == 0 ~ 'm', Gender == 1 ~ 'f')) %>% 
    pivot_wider(id_cols = c(Tr_year_binned, Age_bin),
                names_from = c(gcode), 
                values_from = c(DropOut.subseq.over6mo), 
                names_prefix = 'DropOut.subseq.over6mo.', names_sep = '.') %>% 
    mutate(DropOut.subseq.over6mo.total = DropOut.subseq.over6mo.m + DropOut.subseq.over6mo.f) %>% 
    arrange(Age_bin, Tr_year_binned) %>% select(c(1,2,5,3,4))
  
  return(dat.dropout.subseq.over6mo)
}

# dat.dropout.subseq.over6mo <- fun.dropout.subseq.over6(tr.data, art.report, year.age.sex)
# 
# dat.dropout.subseq.over6mo %>% head()

```  

# Transmissions - full analysis

## Read in all data

```{r Read in all data}
folder.list = Sys.glob(paste0(input_path, "/Simulation_*"))

tr.data.list = list()
event.report.list = list()
art.report.list = list()

for (i in 1:length(folder.list)){
  print(i)
  # transmission data
  f <- paste(folder.list[i], "output/TransmissionReport.csv", sep="/")
  tr.report <- fread(f, check.names = TRUE)
  
  tr.data.list[[i]] <- tr.report %>% 
    mutate(Tr_year_binned = floor(YEAR),
                       Age_bin = floor(SRC_AGE/365/5)*5) %>% 
    mutate(CD4_count_current_binned = case_when(SRC_CD4 < 200 ~ 0, SRC_CD4 >= 200 ~ 1)) %>% 
    mutate(Tr_event_ix = row_number()) %>% 
    select(Tr_year_binned, Tr_event_ix, Tr_year = YEAR, Age_bin, id = SRC_ID, Gender = SRC_GENDER, Age = SRC_AGE, 
           CD4_count_current_binned, VL = SRC_VIRAL_LOAD, SRC_STAGE,
           SIM_TIME)
  
  # diagnosis event data
  
  f <- paste(folder.list[i], "output/ReportEventRecorder.csv", sep="/")
  event.report <- fread(f, check.names = TRUE)
  # filter by year, only keep HIV Diagnosis events
  event.report <- event.report %>% filter(Year >= 2000, Event_Name == "HIVNewlyDiagnosed")
  # keep the first time someone is diagnosed, although I'm pretty sure this can only happen once
  event.report <- event.report %>% arrange(Year) %>% group_by(Individual_ID) %>% slice(1) %>% ungroup()
  event.report <- event.report %>% mutate(Age_Year = Age/365)
  event.report <- event.report %>% mutate(CD4_binned = case_when(CD4 < 200 ~ 0, CD4 >= 200 ~ 1))
  
  event.report.list[[i]] <- event.report %>% select(Individual_ID, Gender, 
                          Year, Age_Year, 
                          Event_Name, 
                          HasHIV, OnART, CD4_binned,
                          Infected, Infectiousness, InterventionStatus, Event_Name)
  
  # art event data
  f <- paste(folder.list[i], "output/ReportHIVART.csv", sep="/")
  art.report <- fread(f, check.names = TRUE)
  
  art.report.list[[i]] <- art.report %>% select(Individual_ID = ID, Age, Gender, CD4, Year, StartingART) %>%
    mutate(event = case_when(StartingART == 1 ~ "InitART", StartingART == 0 ~ "DropOut"))
}



```

## Loop over with analysis
```{r Transmission report analysis}

dat.transm.list = list()

for (i in range(1:length(folder.list))){
  tr.data = tr.data.list[[i]]
  event.report = event.report.list[[i]]
  art.report = art.report.list[[i]]
  
  dat.undiagnosed = fun.undiag(tr.data, event.report, year.age.sex)
  dat.diagnosed.noART <- fun.diag.noart(tr.data, event.report, year.age.sex)
  dat.onart.under6mo.firstinit = fun.onart.under6mo.firstinit(tr.data, art.report, year.age.sex)
  dat.onart.under6mo.reinit <- fun.onart.under6mo.reinit(tr.data, art.report, year.age.sex)
  dat.onart.vl <- fun.onart.vl(tr.data, art.report, year.age.sex)
  dat.onart.under.6mo.vl = fun.onart.under6mo.vl(tr.data, art.report, year.age.sex)
  dat.onart.over.6mo.vl <- fun.onart.over6mo.vl(tr.data, art.report, year.age.sex)
  dat.dropout <- fun.dropout.all(tr.data, art.report, year.age.sex)
  dat.dropout.first <- fun.dropout.first(tr.data, art.report, year.age.sex)
  dat.dropout.subseq.under6mo <- fun.dropout.subseq.under6(tr.data, art.report, year.age.sex)
  dat.dropout.subseq.over6mo <- fun.dropout.subseq.over6(tr.data, art.report, year.age.sex)
  
  dat.transm <- merge(
    dat.undiagnosed,
    dat.diagnosed.noART,
    by = c("Tr_year_binned","Age_bin")
  ) %>% 
    merge( dat.onart.under6mo.firstinit, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.onart.under6mo.reinit, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.onart.vl, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.onart.under.6mo.vl, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.onart.over.6mo.vl, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.dropout, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.dropout.first, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.dropout.subseq.under6mo, by = c("Tr_year_binned","Age_bin") ) %>% 
    merge( dat.dropout.subseq.over6mo, by = c("Tr_year_binned","Age_bin") ) 
  
  dat.transm$sim.id <- i
  print(i)
  
  dat.transm.list[[i]] <- dat.transm
}

dat.transm.list <- bind_rows(dat.transm.list)
```

## Format and prep output
```{r Rescale according to population scale factor}
dat.transm.list <- dat.transm.list %>% 
  inner_join(
    sim.results.pop.scaling %>% select(pop.scaling.factor, sim.id = sim.id.ix),
    by = c("sim.id")
  )

```

```{r Take average across replicates}
colnames(dat.transm.list)

dat.transm.output <- dat.transm.list %>% group_by(Tr_year_binned, Age_bin) %>% 
  summarize(Undiagnosed.total = mean(Undiagnosed.total*pop.scaling.factor),
            Undiagnosed.m = mean(Undiagnosed.m*pop.scaling.factor),
            Undiagnosed.f = mean(Undiagnosed.f*pop.scaling.factor),
            Diagnosed_noART.total = mean(Diagnosed_noART.total*pop.scaling.factor),
            Diagnosed_noART.m = mean(Diagnosed_noART.m*pop.scaling.factor),
            Diagnosed_noART.f = mean(Diagnosed_noART.f*pop.scaling.factor),
            Onart.under6mo.firstinit.under200.total = mean(Onart.under6mo.firstinit.under200.total*pop.scaling.factor),
            Onart.under6mo.firstinit.under200.m = mean(Onart.under6mo.firstinit.under200.m*pop.scaling.factor),
            Onart.under6mo.firstinit.under200.f = mean(Onart.under6mo.firstinit.under200.f*pop.scaling.factor),
            Onart.under6mo.firstinit.over200.total = mean(Onart.under6mo.firstinit.over200.total*pop.scaling.factor),
            Onart.under6mo.firstinit.over200.m = mean(Onart.under6mo.firstinit.over200.m*pop.scaling.factor),
            Onart.under6mo.firstinit.over200.f = mean(Onart.under6mo.firstinit.over200.f*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.under200.total = mean(OnART.afterInterrupt.under6mo.under200.total*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.under200.m = mean(OnART.afterInterrupt.under6mo.under200.m*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.under200.f = mean(OnART.afterInterrupt.under6mo.under200.f*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.over200.total = mean(OnART.afterInterrupt.under6mo.over200.total*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.over200.m = mean(OnART.afterInterrupt.under6mo.over200.m*pop.scaling.factor),
            OnART.afterInterrupt.under6mo.over200.f = mean(OnART.afterInterrupt.under6mo.over200.f*pop.scaling.factor),
            OnART.VL.Supp.total = mean(OnART.VL.Supp.total*pop.scaling.factor),
            OnART.VL.Supp.m = mean(OnART.VL.Supp.m*pop.scaling.factor),
            OnART.VL.Supp.f = mean(OnART.VL.Supp.f*pop.scaling.factor),
            OnART.VL.NoSupp.total = mean(OnART.VL.NoSupp.total*pop.scaling.factor),
            OnART.VL.NoSupp.m = mean(OnART.VL.NoSupp.m*pop.scaling.factor),
            OnART.VL.NoSupp.f = mean(OnART.VL.NoSupp.f*pop.scaling.factor),
            OnART.under6mo.VL.Supp.total = mean(OnART.under6mo.VL.Supp.total*pop.scaling.factor),
            OnART.under6mo.VL.Supp.m = mean(OnART.under6mo.VL.Supp.m*pop.scaling.factor),
            OnART.under6mo.VL.Supp.f = mean(OnART.under6mo.VL.Supp.f*pop.scaling.factor),
            OnART.under6mo.VL.NoSupp.total = mean(OnART.under6mo.VL.NoSupp.total*pop.scaling.factor),
            OnART.under6mo.VL.NoSupp.m = mean(OnART.under6mo.VL.NoSupp.m*pop.scaling.factor),
            OnART.under6mo.VL.NoSupp.f = mean(OnART.under6mo.VL.NoSupp.f*pop.scaling.factor),
            OnART.over6mo.VL.Supp.total = mean(OnART.over6mo.VL.Supp.total*pop.scaling.factor),
            OnART.over6mo.VL.Supp.m = mean(OnART.over6mo.VL.Supp.m*pop.scaling.factor),
            OnART.over6mo.VL.Supp.f = mean(OnART.over6mo.VL.Supp.f*pop.scaling.factor),
            OnART.over6mo.VL.NoSupp.total = mean(OnART.over6mo.VL.NoSupp.total*pop.scaling.factor),
            OnART.over6mo.VL.NoSupp.m = mean(OnART.over6mo.VL.NoSupp.m*pop.scaling.factor),
            OnART.over6mo.VL.NoSupp.f = mean(OnART.over6mo.VL.NoSupp.f*pop.scaling.factor),
            DropOut.total = mean(DropOut.total*pop.scaling.factor),
            DropOut.m = mean(DropOut.m*pop.scaling.factor),
            DropOut.f = mean(DropOut.f*pop.scaling.factor),
            DropOut.first.total = mean(DropOut.first.total*pop.scaling.factor),
            DropOut.first.m = mean(DropOut.first.m*pop.scaling.factor),
            DropOut.first.f = mean(DropOut.first.f*pop.scaling.factor),
            DropOut.subseq.under6mo.total = mean(DropOut.subseq.under6mo.total*pop.scaling.factor),
            DropOut.subseq.under6mo.m = mean(DropOut.subseq.under6mo.m*pop.scaling.factor),
            DropOut.subseq.under6mo.f = mean(DropOut.subseq.under6mo.f*pop.scaling.factor),
            DropOut.subseq.over6mo.total = mean(DropOut.subseq.over6mo.total*pop.scaling.factor),
            DropOut.subseq.over6mo.m = mean(DropOut.subseq.over6mo.m*pop.scaling.factor),
            DropOut.subseq.over6mo.f = mean(DropOut.subseq.over6mo.f*pop.scaling.factor) )

```


```{r Join with reports data}
dat.transm.output <- merge(dat.plhiv %>% mutate(Year = Year- .5), dat.hivdeaths , by = c("Year","Age")) %>% 
  rename(Age_bin = Age, Tr_year_binned = Year) %>% 
  merge(dat.transm.output, by = c("Tr_year_binned","Age_bin")) %>% 
  arrange(Age_bin, Tr_year_binned)
```

## Save output

```{r Save output}
write_excel_csv(dat.transm.output, "mihpsa_transmissions_table.csv")
```

## Additional Analysis

### Total number of people in each category

Count people in each of four categories:
* Undiagnosed
* Diagnosed, not yet on ART
* On ART
* Off ART

Age groups
* 15-24
* 25-34
* 35+

Issue is that before I was counting transmissions. Now I need to count people.
#### Counting undiagnosed
```{r}
dat.undiagnosed <- sim.results %>% group_by(Year, Gender, Age, sim.ix) %>% 
  summarize(Population = sum(Population * pop.scaling.factor),
            Infected = sum(Infected * pop.scaling.factor),
            Diagnosed = sum(Diagnosed * pop.scaling.factor)) %>% 
  group_by(Year, Gender, Age) %>% 
  summarize(Population = mean(Population),
            Infected = mean(Infected),
            Diagnosed = mean(Diagnosed)) %>% 
  ungroup() %>% 
  mutate(Undiagnosed = Infected - Diagnosed)

dat.undiagnosed %>% head
```

#### Counting On ART
```{r}
dat.onart <- sim.results %>% group_by(Year, Gender, Age, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop.scaling.factor)) %>% 
  group_by(Year, Gender, Age) %>% 
  summarize(On_ART = mean(On_ART), .groups = 'keep') %>% 
  ungroup()

dat.onart
```

#### Counting Off ART

At least one interruption




```{r}
art.report.dropout <- art.report %>% 
    arrange(Year) %>% 
    group_by(Individual_ID, event) %>% 
    mutate(event_ix = row_number())
# pair each dropout event with the subsequent art init event
art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix =
  art.report.dropout[which(art.report.dropout$event == 'DropOut'),]$event_ix +1

art.report.dropout %>% 
  full_join(art.report.dropout$Year, by = Year)

cross_join(
  data.table(Year.round = c(2001:2047)), 
  art.report.dropout
) %>% View

# In any given year, how many individuals have *most recently* initiated ART?
art.report.dropout$Year %>% unique 

art.report.dropout %>% group_by(Year) %>% slice(1) %>% View

# In any given year, how many individuals have *most recently* dropped out of ART?

```


```{r}
input_path = "/gpfs/scratch/citrod01/experiments/Malawi/Baseline-campaign_Malawi_20220422_recalib-mort___2023_11_06_21_47_46_089549/"

sim.results.mort <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = input_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive", "Newly.Tested.Negative",
                        "Population","Infected", "On_ART","Died", "Died_from_HIV",
                        "Tested.Past.Year.or.On_ART", "Tested.Ever","Diagnosed" ),
  stratify_columns = c("Year", "Gender", "Age"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
) %>% 
  ungroup()
```

```{r}
sim.results %>% filter(sim.ix == 2)
```


```{r}
sim.results.mort %>% filter(sim.ix == 2)
```

